name: Github Release

on:
  workflow_call:
    inputs:
      tag:
        description: "The tag to release (for manual releases). If not provided, uses semantic-release for automatic versioning."
        type: string
        required: false
      use_semantic_release:
        description: "Use semantic-release for automatic versioning and changelog generation"
        type: boolean
        default: true
      update_version_aliases:
        description: "Automatically update version alias tags (e.g., v1 and v1.2) to point to the latest release."
        type: boolean
        default: false
      use_github_app:
        description: "Use GitHub App token to bypass branch protection (requires GH_APP_ID and GH_APP_PRIVATE_KEY secrets)"
        type: boolean
        default: false
    secrets:
      GH_APP_ID:
        description: "GitHub App ID (required if use_github_app is true)"
        required: false
      GH_APP_PRIVATE_KEY:
        description: "GitHub App private key (required if use_github_app is true)"
        required: false
    outputs:
      version:
        description: "The version that was released"
        value: ${{ jobs.determine-version.outputs.version }}
      new_release_published:
        description: "Whether a new release was published"
        value: ${{ jobs.determine-version.outputs.new_release_published }}

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    if: inputs.use_semantic_release == true
    outputs:
      version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Semantic Release (Dry Run)
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          dry_run: true
          branches: |
            [
              'main'
            ]
          semantic_version: 24.2.0
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
            conventional-changelog-conventionalcommits@8.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display version
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "üì¶ New version will be: v${{ steps.semantic.outputs.new_release_version }}"
          echo "   Release notes:"
          echo "${{ steps.semantic.outputs.new_release_notes }}"

      - name: No release needed
        if: steps.semantic.outputs.new_release_published == 'false'
        run: |
          echo "‚ÑπÔ∏è  No release needed - no significant changes since last release"

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [determine-version]
    if: |
      always() &&
      (inputs.use_semantic_release == false ||
       needs.determine-version.outputs.new_release_published == 'true')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Generate GitHub App Token
        if: inputs.use_semantic_release == true && inputs.use_github_app == true
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ (inputs.use_semantic_release == true && inputs.use_github_app == true) && steps.generate-token.outputs.token || github.token }}

      - name: Semantic Release
        if: inputs.use_semantic_release == true
        uses: cycjimmy/semantic-release-action@v4
        with:
          branches: |
            [
              'main'
            ]
          semantic_version: 24.2.0
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
            conventional-changelog-conventionalcommits@8.0.0
        env:
          GITHUB_TOKEN: ${{ (inputs.use_github_app == true) && steps.generate-token.outputs.token || github.token }}

      - name: Manual Release
        if: inputs.use_semantic_release == false && inputs.tag != ''
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          tag_name: ${{ inputs.tag }}
          generate_release_notes: true

      - name: Update major and minor version tags
        if: inputs.use_semantic_release == true && inputs.update_version_aliases == true
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Update major version tag (e.g., v3)
          git tag -fa "v${MAJOR}" -m "Update major version tag to ${VERSION}"
          git push origin "v${MAJOR}" --force

          # Update minor version tag (e.g., v3.6)
          git tag -fa "v${MAJOR}.${MINOR}" -m "Update minor version tag to ${VERSION}"
          git push origin "v${MAJOR}.${MINOR}" --force

          echo "‚úÖ Updated version aliases: v${MAJOR}, v${MAJOR}.${MINOR}"
