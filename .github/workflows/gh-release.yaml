name: Github Semantic Release [Alpha]

on:
  workflow_call:
    inputs:
      tag:
        description: "The tag to release (for manual releases). If not provided, uses semantic-release for automatic versioning."
        type: string
        required: false
      tag_format:
        description: "The format of the tag to release. If not provided, uses the tagFormat from .releaserc.json or semantic-release default (v${version})."
        type: string
        required: false
      use_semantic_release:
        description: "Use semantic-release for automatic versioning and changelog generation"
        type: boolean
        default: true
      working_directory:
        description: "The working directory where the project is located (relative to the repository root)."
        type: string
      update_version_aliases:
        description: "Automatically update version alias tags (e.g., v1 and v1.2) to point to the latest release."
        type: boolean
        default: false
      dry_run:
        description: "Run in dry-run mode to preview the release without creating it."
        type: boolean
        default: false
      app_id:
        description: "GitHub App ID (for generating a token if using GitHub App authentication)"
        type: string
        required: false
    secrets:
      app_private_key:
        description: "GitHub App private key (for generating a token if using GitHub App authentication)"
        required: false
    outputs:
      new_release_published:
        description: "Whether a new release was published (true or false)"
        value: ${{ jobs.release.outputs.new_release_published }}
      new_release_version:
        description: "Version of the new release (e.g. 1.3.0)"
        value: ${{ jobs.release.outputs.new_release_version }}
      new_release_major_version:
        description: "Major version of the new release (e.g. 1)"
        value: ${{ jobs.release.outputs.new_release_major_version }}
      new_release_minor_version:
        description: "Minor version of the new release (e.g. 3)"
        value: ${{ jobs.release.outputs.new_release_minor_version }}
      new_release_patch_version:
        description: "Patch version of the new release (e.g. 0)"
        value: ${{ jobs.release.outputs.new_release_patch_version }}
      new_release_git_tag:
        description: "The Git tag associated with the new release (e.g. v1.3.0)"
        value: ${{ jobs.release.outputs.new_release_git_tag }}
      new_release_git_head:
        description: "The sha of the last commit being part of the new release"
        value: ${{ jobs.release.outputs.new_release_git_head }}
      dry_run:
        description: "Whether this was a dry-run (true) or actual release (false)"
        value: ${{ jobs.release.outputs.dry_run }}

env:
  GIT_USER_NAME: "tamedia-fission[bot]"
  GIT_USER_EMAIL: "238147500+tamedia-fission[bot]@users.noreply.github.com"

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_major_version: ${{ steps.semantic.outputs.new_release_major_version }}
      new_release_minor_version: ${{ steps.semantic.outputs.new_release_minor_version }}
      new_release_patch_version: ${{ steps.semantic.outputs.new_release_patch_version }}
      new_release_git_tag: ${{ steps.semantic.outputs.new_release_git_tag }}
      new_release_git_head: ${{ steps.semantic.outputs.new_release_git_head }}
      dry_run: ${{ inputs.dry_run == true || github.event_name == 'pull_request' }}
    steps:
      - name: Generate GitHub App Token
        if: inputs.use_semantic_release == true && inputs.app_id != ''
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ inputs.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ (inputs.use_semantic_release == true && inputs.app_id != '') && steps.generate-token.outputs.token || github.token }}

      - name: Configure Git for semantic-release
        if: inputs.use_semantic_release == true && inputs.app_id != ''
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Temporarily merge PR branch
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          git checkout ${{ github.event.pull_request.base.ref }}
          git merge --squash origin/${{ github.event.pull_request.head.ref }}
          git commit -m "${{ github.event.pull_request.title }}"

      - name: Semantic Release
        if: inputs.use_semantic_release == true
        id: semantic
        uses: cycjimmy/semantic-release-action@v5
        with:
          dry_run: ${{ inputs.dry_run || github.event_name == 'pull_request' }}
          unset_gha_env: ${{ github.event_name == 'pull_request' }}
          ci: ${{ github.event_name == 'pull_request' && false || true }}
          tag_format: ${{ inputs.tag_format }}
          working_directory: ${{ inputs.working_directory }}
          branches: |
            [
              'main',
              'master'
            ]
          semantic_version: 24.2.0
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
            conventional-changelog-conventionalcommits@8.0.0
        env:
          GITHUB_TOKEN: ${{ (inputs.app_id != '') && steps.generate-token.outputs.token || github.token }}

      - name: Manual Release
        if: inputs.use_semantic_release == false && inputs.tag != '' && inputs.dry_run == false
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
        with:
          tag_name: ${{ inputs.tag }}
          generate_release_notes: true

      - name: Update major and minor version tags
        if: inputs.use_semantic_release == true && inputs.update_version_aliases == true && inputs.dry_run == false && github.event_name != 'pull_request' && steps.semantic.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ (inputs.app_id != '') && steps.generate-token.outputs.token || github.token }}
        run: |
          # Update major version tag (e.g., v3)
          git tag -fa "v${{ steps.semantic.outputs.new_release_major_version }}" -m "Update major version tag to ${{ steps.semantic.outputs.new_release_version }}"
          git push origin "v${{ steps.semantic.outputs.new_release_major_version }}" --force

          # Update minor version tag (e.g., v3.6)
          git tag -fa "v${{ steps.semantic.outputs.new_release_major_version }}.${{ steps.semantic.outputs.new_release_minor_version }}" -m "Update minor version tag to ${{ steps.semantic.outputs.new_release_version }}"
          git push origin "v${{ steps.semantic.outputs.new_release_major_version }}.${{ steps.semantic.outputs.new_release_minor_version }}" --force

          echo "âœ… Updated version aliases: v${{ steps.semantic.outputs.new_release_major_version }}, v${{ steps.semantic.outputs.new_release_major_version }}.${{ steps.semantic.outputs.new_release_minor_version }}"
