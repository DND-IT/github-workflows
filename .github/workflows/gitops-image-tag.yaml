# Simple workflow to update the image tag in a Helm values file
# and create a pull request if needed. This should be migrated to an action
# in the future.
name: Update Helm Image Tag in Values.yaml

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'The tag of the Docker image'
        type: string
        required: true
      image_tag_keys:
        description: 'Newline-separated list of keys to update (e.g., webapp.image.tag). Ignored when image_name is set.'
        type: string
        default: ''
      image_name:
        description: 'Image name to search for (e.g., social-media). Finds all image blocks where the repository ends with this name and updates their tag. Takes precedence over image_tag_keys.'
        type: string
        default: ''
      values_files:
        description: 'Newline-separated list of file paths to update'
        type: string
        required: true
      create_pr:
        description: |
          Create a pull request. If false, the changes will be committed directly to the target branch.
          Github Actions must have write permissions to the repository. If branch protection is enabled a Github App is required and is able to bypass branch protection rules.
        type: boolean
        default: true
      pr_message:
        description: 'Custom message for the pull request. Defaults to a standard message.'
        type: string
        default: 'This PR updates the Helm values files to use the latest image tag.'
      auto_merge:
        description: 'Enable auto-merge for the pull request. Only works if create_pr is true.'
        type: boolean
        default: false
      branch_name_prefix:
        description: 'Prefix for the branch name.'
        type: string
        default: 'helm-values'
      target_branch:
        description: 'The target branch for the pull request. Defaults the default branch of the repository.'
        type: string
        default: ${{ github.event.repository.default_branch }}
      app_id:
        description: 'GitHub App ID for generating a token. Required if using GitHub App authentication.'
        type: string
        required: false
    secrets:
      app_private_key:
        description: 'Private key for the GitHub App. Required if using GitHub App authentication.'
        required: false

jobs:
  update-helm-values:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Update Helm values files
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.image_name }}"

          # Validate inputs
          if [ -z "$IMAGE_TAG" ]; then
            echo "Error: image_tag input cannot be empty"
            exit 1
          fi
          if [ -z "${{ inputs.values_files }}" ]; then
            echo "Error: values_files input cannot be empty"
            exit 1
          fi
          if [ -z "$IMAGE_NAME" ] && [ -z "${{ inputs.image_tag_keys }}" ]; then
            echo "Error: either image_name or image_tag_keys must be provided"
            exit 1
          fi

          echo "Files to update:"
          echo "${{ inputs.values_files }}"

          if [ -n "$IMAGE_NAME" ]; then
            echo ""
            echo "Image name to search for: $IMAGE_NAME"
          else
            echo ""
            echo "Keys to update:"
            echo "${{ inputs.image_tag_keys }}"
          fi

          # Process each file (newline-separated)
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue

            echo ""
            echo "Updating $file with image tag: $IMAGE_TAG"

            if [ -n "$IMAGE_NAME" ]; then
              # --- IMAGE NAME SEARCH MODE ---
              # Find all dot-notation paths to tag fields where sibling repository ends with the image name
              TAG_PATHS=$(yq '
                (.. | select(has("repository") and has("tag")) | select(.repository | test("'"${IMAGE_NAME}"'$"))).tag | path | "." + join(".")
              ' "$file" 2>/dev/null)

              if [ -z "$TAG_PATHS" ]; then
                echo "  No image blocks matching '$IMAGE_NAME' found in $file, skipping"
                continue
              fi

              while IFS= read -r tag_path; do
                [ -z "$tag_path" ] && continue
                current_value=$(yq "$tag_path" "$file")
                if [ "$current_value" = "$IMAGE_TAG" ]; then
                  echo "  $tag_path already up to date"
                  continue
                fi
                LINE=$(yq "$tag_path | line" "$file")
                sed -i "${LINE}s|tag: .*|tag: \"${IMAGE_TAG}\"|" "$file"
                echo "  $tag_path = $IMAGE_TAG (line $LINE)"
              done <<< "$TAG_PATHS"
            else
              # --- EXPLICIT KEYS MODE ---
              while IFS= read -r key; do
                [ -z "$key" ] && continue

                # Check if key exists before updating
                if yq e ".$key" "$file" >/dev/null 2>&1 && [ "$(yq e ".$key" "$file")" != "null" ]; then
                  echo "  Setting $key = $IMAGE_TAG"
                  current_value=$(yq e ".$key" "$file")
                  if [ "$current_value" != "$IMAGE_TAG" ]; then
                    # Use yq to find the exact line, then sed to preserve formatting
                    LINE=$(yq ".$key | line" "$file")
                    sed -i "${LINE}s|${key##*.}: .*|${key##*.}: \"${IMAGE_TAG}\"|" "$file"
                  else
                    echo "  Value already up to date"
                  fi
                else
                  echo "  Key $key not found in $file, skipping"
                fi
              done <<< "${{ inputs.image_tag_keys }}"
            fi
          done <<< "${{ inputs.values_files }}"

      - name: Generate PR details
        id: pr_details
        run: |
          # Create a hash of the files being updated for consistent branch naming
          FILES_HASH=$(echo "${{ inputs.values_files }}" | sha256sum | cut -c1-8)
          echo "branch_name=${{ inputs.branch_name_prefix }}-$FILES_HASH" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: inputs.create_pr == true
        id: create_pr
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update image tag to ${{ inputs.image_tag }}'
          title: 'Update image tag to ${{ inputs.image_tag }}'
          body: |
            ${{ inputs.pr_message }}

            **New tag**:
            ```
            ${{ inputs.image_tag }}
            ```

            **Image**: `${{ inputs.image_name || 'N/A' }}`

            **Keys to update**:
            ```
            ${{ inputs.image_tag_keys || 'auto-detected via image_name' }}
            ```

            **Files to update**:
            ```
            ${{ inputs.values_files }}
            ```

            *This change was automatically generated by the ${{ github.workflow }} workflow.*
          branch: ${{ steps.pr_details.outputs.branch_name }}
          base: ${{ inputs.target_branch }}
          delete-branch: true

      - name: Generate a token
        id: generate-token
        if: inputs.auto_merge == true
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ inputs.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - name: Enable auto-merge
        if: inputs.create_pr == true && steps.create_pr.outputs.pull-request-number && inputs.auto_merge == true
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.create_pr.outputs.pull-request-number }}"

          # Add a comment explaining the auto-merge
          gh pr comment "${{ steps.create_pr.outputs.pull-request-number }}" \
            --body "This PR will be automatically merged once all checks pass."

          # Enable auto-merge
          gh pr merge "${{ steps.create_pr.outputs.pull-request-number }}" \
            --auto \
            --squash \
            --delete-branch

      - name: Commit changes
        if: inputs.create_pr == false && steps.generate-token.outputs.token
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

          TARGET_BRANCH="${{ inputs.target_branch }}"
          if [ -z "$TARGET_BRANCH" ]; then
            TARGET_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          fi

          git checkout "$TARGET_BRANCH" 2>/dev/null || git checkout -b "$TARGET_BRANCH"
          git pull origin "$TARGET_BRANCH" 2>/dev/null || true

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            git add "$file"
          done <<< "${{ inputs.values_files }}"

          git commit -m "chore: update image tag to ${{ inputs.image_tag }}"
          git push origin "$TARGET_BRANCH"
