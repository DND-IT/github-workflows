# Simple workflow to update the image tag in a Helm values file
# and create a pull request if needed. This should be migrated to an action
# in the future.
name: Update Helm Image Tag in Values.yaml

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'The tag of the Docker image'
        required: true
        type: string
      image_tag_key:
        description: 'Key in the values file to update (e.g., image.tag)'
        default: 'image_tag' # Webapp helm chart uses image_tag
        type: string
      values_file:
        description: 'Path to the Helm values file'
        default: 'deploy/app/values-common.yaml'
        type: string
      create_pr:
        description: 'Whether to create a pull request'
        default: true
        type: boolean
      target_branch:
        description: 'The target branch for the pull request. Defaults the default branch of the repository.'
        type: string

jobs:
  update-helm-values:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Update Helm values.yaml
        run: |
          echo "Updating ${{ inputs.values_file }} image tag:${{ inputs.image_tag }}"

          yq -i e ".${{ inputs.image_tag_key }} = \"${{ inputs.image_tag }}\"" ${{ inputs.values_file }}

      - name: Create Pull Request
        if: inputs.create_pr
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update ${{ inputs.values_file }} image tag to ${{ inputs.image_tag }}'
          title: 'Update ${{ inputs.values_file }} to ${{ inputs.image_tag }}'
          body: |
            This PR updates the Helm values file to use the latest image tag.

            - New tag: `${{ inputs.image_tag }}`
            - Updated file: `${{ inputs.values_file }}`

            This change was automatically generated by the Update Helm Values workflow.
          branch: update-helm-values-${{ inputs.image_tag }}
          base: ${{ inputs.target_branch || github.repository.default_branch }}

      - name: Commit changes
        if: inputs.create_pr == false
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git checkout ${{ inputs.target_branch || github.repository.default_branch }}
          git pull
          git add ${{ inputs.values_file }}
          git commit -m "chore: update ${{ inputs.values_file }} image tag to ${{ inputs.image_tag }}"
          git push origin ${{ inputs.target_branch || github.repository.default_branch }}
